{"componentChunkName":"component---src-templates-blog-detail-tsx","path":"/blog/eager-loading-hasmany-relationship-laravel","result":{"data":{"blog":{"remark":{"html":"<p><a href=\"https://laravel.com/docs/8.x/eloquent-relationships#eager-loading\">Eager loading</a> relationships in Laravel makes it\nreally easy to avoid N+1 query problems. This occurs when you run an additional query for each result in a previous\nquery. Take for example a model <code class=\"language-text\">Post</code> that has a <code class=\"language-text\">hasOne</code> relationship with <code class=\"language-text\">User</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$posts</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Post</span><span class=\"token operator\">::</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$posts</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$post</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Retrieve the post author</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">user</span><span class=\"token operator\">-></span><span class=\"token property\">name</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This would run an additional query for each post author. To avoid this we use eager loading. This essentially lazy loads\nthe relationship into one extra query.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$posts</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Post</span><span class=\"token operator\">::</span><span class=\"token function\">with</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'user'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now imagine the reverse of that example. You want to query all users and get their latest post. Easy we use eager\nloading to lazy load the <code class=\"language-text\">posts</code> relationship.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$users</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">User</span><span class=\"token operator\">::</span><span class=\"token function\">with</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'posts'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In this case eager loading causes to load all posts for every user. This is bad because we only need the latest post.</p>\n<p>Because the user model has a <code class=\"language-text\">hasMany</code> relationship with posts, all posts are eager loaded for every user. To solve this\nyou might think a simple <code class=\"language-text\">-&gt;limit(1)</code> would do the\ntrick. <a href=\"https://laravel.com/docs/8.x/eloquent-relationships#constraining-eager-loads\">But that does not work</a>.</p>\n<p>The solution is actually pretty simple. In order to load the latest post you can simply create a new <code class=\"language-text\">hasOne</code>\nrelationship on the <code class=\"language-text\">User</code> model.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">latestPost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">hasOne</span><span class=\"token punctuation\">(</span><span class=\"token class-name static-context\">Post</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">latest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When you use this relationship with eager loading only one post will be queried per user.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$users</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">User</span><span class=\"token operator\">::</span><span class=\"token function\">with</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'latestPost'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$users</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Retrieve the latest post</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">latestPost</span><span class=\"token operator\">-></span><span class=\"token property\">title</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If you're wondering how you can easily keep track of how many queries are run I highly recommend you\ninstall <a href=\"https://github.com/barryvdh/laravel-debugbar\">barryvdh/laravel-debugbar</a>.</p>","excerpt":"Eager loading relationships in Laravel makes it\nreally easy to avoid N+1 query problems. This occursâ€¦","frontmatter":{"date":"February 1, 2021","slug":"/blog/eager-loading-hasmany-relationship-laravel","title":"Eager loading hasMany relationship","tags":["Laravel","Eloquent"]},"fields":{"readingTime":{"text":"2 min read"}}}},"blogs":{"nodes":[],"pageInfo":{"hasNextPage":false}}},"pageContext":{"slug":"/blog/eager-loading-hasmany-relationship-laravel"}},"staticQueryHashes":["2778467721"]}